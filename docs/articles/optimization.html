<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Design optimization with PopED • PopED</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Design optimization with PopED">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PopED</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.3.2.9005</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/intro-poped.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/andrewhooker/PopED">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Design optimization with PopED</h1>
                        <h4 class="author">Andrew Hooker</h4>
            
            <h4 class="date">2018-06-28</h4>
      
      
      <div class="hidden name"><code>optimization.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The standard function to optimize designs in PopED is <code>poped_optim</code>. This function is quite flexible and allows for optimization of a number of different types of design variables using a number of different optimization algorithms. However, <code>poped_optim</code> may not suit all needs for design optimization. To that end, PopED has methods implemented to ease the use of other optimization tools. Below, the types of optimization problems one might want to solve and the algorithms used to solve these problems are presented.</p>
<div id="define-a-model" class="section level2">
<h2 class="hasAnchor">
<a href="#define-a-model" class="anchor"></a>Define a model</h2>
<p>First we have to define a model, designs and design space. We choose a simple 1-compartment model with linear elimination and absorption. The design is one group of individuals with a single oral dose of a drug with 8 sample time points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co">#-- Model: One comp first order absorption</span>
ff &lt;-<span class="st"> </span><span class="cf">function</span>(model_switch,xt,parameters,poped.db){
  <span class="kw">with</span>(<span class="kw">as.list</span>(parameters),{
    y=xt
    y=(DOSE<span class="op">*</span>KA<span class="op">/</span>(V<span class="op">*</span>(KA<span class="op">-</span>CL<span class="op">/</span>V)))<span class="op">*</span>(<span class="kw">exp</span>(<span class="op">-</span>CL<span class="op">/</span>V<span class="op">*</span>xt)<span class="op">-</span><span class="kw">exp</span>(<span class="op">-</span>KA<span class="op">*</span>xt))
    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">y=</span>y,<span class="dt">poped.db=</span>poped.db))
  })
}

<span class="co"># -- parameter definition function </span>
sfg &lt;-<span class="st"> </span><span class="cf">function</span>(x,a,bpop,b,bocc){
  parameters=<span class="kw">c</span>(<span class="dt">CL=</span>bpop[<span class="dv">1</span>]<span class="op">*</span><span class="kw">exp</span>(b[<span class="dv">1</span>]),
               <span class="dt">V=</span>bpop[<span class="dv">2</span>]<span class="op">*</span><span class="kw">exp</span>(b[<span class="dv">2</span>]),
               <span class="dt">KA=</span>bpop[<span class="dv">3</span>]<span class="op">*</span><span class="kw">exp</span>(b[<span class="dv">3</span>]),
               <span class="dt">DOSE=</span>a[<span class="dv">1</span>])
  <span class="kw">return</span>(parameters) 
}

## -- Define initial design  and design space
poped.db &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create.poped.database.html">create.poped.database</a></span>(<span class="dt">ff_fun=</span>ff,
                                  <span class="dt">fg_fun =</span> sfg,
                                  <span class="dt">fError_fun =</span> feps.add.prop,
                                  <span class="dt">bpop=</span><span class="kw">c</span>(<span class="dt">CL=</span><span class="fl">0.15</span>, <span class="dt">V=</span><span class="dv">8</span>, <span class="dt">KA=</span><span class="fl">1.0</span>), 
                                  <span class="dt">notfixed_bpop=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),
                                  <span class="dt">d=</span><span class="kw">c</span>(<span class="dt">CL=</span><span class="fl">0.07</span>, <span class="dt">V=</span><span class="fl">0.02</span>, <span class="dt">KA=</span><span class="fl">0.6</span>), 
                                  <span class="dt">sigma=</span><span class="kw">c</span>(<span class="fl">0.01</span>,<span class="fl">0.25</span>),
                                  <span class="dt">groupsize=</span><span class="dv">32</span>,
                                  <span class="dt">xt=</span><span class="kw">c</span>( <span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">6</span>,<span class="dv">24</span>,<span class="dv">36</span>,<span class="dv">72</span>,<span class="dv">120</span>),
                                  <span class="dt">minxt=</span><span class="dv">0</span>,
                                  <span class="dt">maxxt=</span><span class="dv">120</span>,
                                  <span class="dt">a=</span><span class="kw">c</span>(<span class="dt">DOSE=</span><span class="dv">70</span>),
                                  <span class="dt">mina=</span><span class="dv">0</span>,
                                  <span class="dt">maxa=</span><span class="dv">100</span>)

<span class="co">#  create plot of model  </span>
<span class="kw"><a href="../reference/plot_model_prediction.html">plot_model_prediction</a></span>(poped.db,<span class="dt">IPRED =</span> T, <span class="dt">DV =</span> T)</code></pre></div>
<p><img src="optimization_files/figure-html/model_design_ds-1.png" width="700"></p>
</div>
</div>
<div id="design-optimization" class="section level1">
<h1 class="hasAnchor">
<a href="#design-optimization" class="anchor"></a>Design optimization</h1>
<p>We can optimize the sample times of the design<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. The search for the optimal design is numerically challenging and it is important to use an optimizer which is robust with respect to the choice of the</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output &lt;-<span class="st"> </span><span class="kw"><a href="../reference/poped_optim.html">poped_optim</a></span>(poped.db, <span class="dt">opt_xt=</span>T)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(output)
<span class="co">#&gt; ===============================================================================</span>
<span class="co">#&gt; FINAL RESULTS</span>
<span class="co">#&gt; Optimized Sampling Schedule</span>
<span class="co">#&gt; Group 1:  0.659  5.771  5.772  5.772  5.772  101.7    102    102</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; OFV = 56.7172</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Efficiency: </span>
<span class="co">#&gt;   ((exp(ofv_final) / exp(ofv_init))^(1/n_parameters)) = 1.1795</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Expected parameter </span>
<span class="co">#&gt; relative standard error (%RSE):</span>
<span class="co">#&gt;     Parameter   Values   RSE_0     RSE</span>
<span class="co">#&gt;       bpop[1]     0.15    5.10    5.12</span>
<span class="co">#&gt;       bpop[2]     8.00    3.03    2.74</span>
<span class="co">#&gt;       bpop[3]     1.00   14.26   14.33</span>
<span class="co">#&gt;        D[1,1]     0.07   29.76   30.15</span>
<span class="co">#&gt;        D[2,2]     0.02   36.68   30.04</span>
<span class="co">#&gt;        D[3,3]     0.60   26.75   27.33</span>
<span class="co">#&gt;    SIGMA[1,1]     0.01   32.01   22.01</span>
<span class="co">#&gt;    SIGMA[2,2]     0.25   25.64   19.48</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Total running time: 20.915 seconds</span>
<span class="kw"><a href="../reference/plot_model_prediction.html">plot_model_prediction</a></span>(output<span class="op">$</span>poped.db)</code></pre></div>
<p><img src="optimization_files/figure-html/unnamed-chunk-1-1.png" width="576"></p>
<p>We see that there are three distinct sample times for this design (support points) with an uneven distribution of sample times at each support point. This means that for this model, with these exact parameter values, that the most information from the study to inform the parameter estimation is with these sample times.</p>
<div id="examine-efficiency-of-sampling-windows" class="section level3">
<h3 class="hasAnchor">
<a href="#examine-efficiency-of-sampling-windows" class="anchor"></a>Examine efficiency of sampling windows</h3>
<p>Of course, this means that there are multiple samples at some of these time points. We can explore a more practical design by looking at the loss of efficiency if we spread out sample times in a uniform distribution around these optimal points (<span class="math inline">\(\pm 30\)</span> minutes).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_efficiency_of_windows.html">plot_efficiency_of_windows</a></span>(output<span class="op">$</span>poped.db,<span class="dt">xt_windows=</span><span class="fl">0.5</span>)</code></pre></div>
<p><img src="optimization_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<p>Here we see the efficiency (<span class="math inline">\((|FIM_{optimized}|/|FIM_{initial}|)^{1/npar}\)</span>) drop below 80% in some cases, which is mostly caused by an increase in the D[2,2] parameter uncertainty (BSV on absorption). Smaller windows or different windowing on different samples may be in order here. To investigate see <code><a href="../reference/plot_efficiency_of_windows.html">?plot_efficiency_of_windows</a></code>.</p>
</div>
<div id="optimize-over-a-discrete-design-space" class="section level3">
<h3 class="hasAnchor">
<a href="#optimize-over-a-discrete-design-space" class="anchor"></a>Optimize over a discrete design space</h3>
<p>In the previous example we optimized over a continuous design space (sample times could be optimized to be any value between a lower and an upper limit). We could also limit the search to only “allowed” values, for example, only samples taken on the half-hour are allowed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">poped.db.discrete &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create.poped.database.html">create.poped.database</a></span>(poped.db,<span class="dt">discrete_xt =</span> <span class="kw">list</span>(<span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">120</span>,<span class="dt">by=</span><span class="fl">0.5</span>)))
                                          
output_discrete &lt;-<span class="st"> </span><span class="kw"><a href="../reference/poped_optim.html">poped_optim</a></span>(poped.db.discrete, <span class="dt">opt_xt=</span>T)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(output_discrete)
<span class="co">#&gt; ===============================================================================</span>
<span class="co">#&gt; FINAL RESULTS</span>
<span class="co">#&gt; Optimized Sampling Schedule</span>
<span class="co">#&gt; Group 1:    0.5    5.5    5.5    5.5    5.5   96.5     98    106</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; OFV = 56.6995</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Efficiency: </span>
<span class="co">#&gt;   ((exp(ofv_final) / exp(ofv_init))^(1/n_parameters)) = 1.1769</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Expected parameter </span>
<span class="co">#&gt; relative standard error (%RSE):</span>
<span class="co">#&gt;     Parameter   Values   RSE_0     RSE</span>
<span class="co">#&gt;       bpop[1]     0.15    5.10    5.11</span>
<span class="co">#&gt;       bpop[2]     8.00    3.03    2.74</span>
<span class="co">#&gt;       bpop[3]     1.00   14.26   14.37</span>
<span class="co">#&gt;        D[1,1]     0.07   29.76   30.04</span>
<span class="co">#&gt;        D[2,2]     0.02   36.68   30.06</span>
<span class="co">#&gt;        D[3,3]     0.60   26.75   27.49</span>
<span class="co">#&gt;    SIGMA[1,1]     0.01   32.01   22.00</span>
<span class="co">#&gt;    SIGMA[2,2]     0.25   25.64   19.62</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Total running time: 31.488 seconds</span>
<span class="kw"><a href="../reference/plot_model_prediction.html">plot_model_prediction</a></span>(output_discrete<span class="op">$</span>poped.db)</code></pre></div>
<p><img src="optimization_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
<p>Here we see that the optimization ran somewhat quicker, but gave a less efficient design.</p>
</div>
<div id="optimize-other-design-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#optimize-other-design-variables" class="anchor"></a>Optimize ‘Other’ design variables</h3>
<p>One could also optimize over dose, to see if a different dose could help in parameter estimation .</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output_dose_opt &lt;-<span class="st"> </span><span class="kw"><a href="../reference/poped_optim.html">poped_optim</a></span>(output<span class="op">$</span>poped.db, <span class="dt">opt_xt=</span>T, <span class="dt">opt_a=</span>T)</code></pre></div>
<p>In this case the results are predictable … higher doses give observations with somewhat lower absolute residual variability leading to both groups at the highest allowed dose levels (200 mg in this case).</p>
</div>
<div id="cost-function-to-optimize-dose" class="section level3">
<h3 class="hasAnchor">
<a href="#cost-function-to-optimize-dose" class="anchor"></a>Cost function to optimize dose</h3>
<p>Optimizing the dose of a study just to have better model parameter estimates may be somewhat implausible. Instead, let’s use a cost function to optimize dose based on some sort of target concentration … perhaps <span class="math inline">\(C_{max}\)</span> of 7 mg/L.</p>
<p>First we define the criteria we use to optimize the doses, here a least squares minimization.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">crit_fcn &lt;-<span class="st"> </span><span class="cf">function</span>(poped.db,...){
  pred_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/model_prediction.html">model_prediction</a></span>(poped.db,<span class="dt">model_num_points =</span> <span class="dv">1000</span>)
  <span class="kw">return</span>((<span class="kw">max</span>(pred_df<span class="op">$</span>PRED)<span class="op">-</span><span class="dv">7</span>)<span class="op">^</span><span class="dv">2</span>)
}
<span class="kw">crit_fcn</span>(output<span class="op">$</span>poped.db)
<span class="co">#&gt; [1] 1.231404</span></code></pre></div>
<p>Now we minimize the cost function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output_cost &lt;-<span class="st"> </span><span class="kw"><a href="../reference/poped_optim.html">poped_optim</a></span>(poped.db, <span class="dt">opt_a =</span>T, <span class="dt">opt_xt =</span> F,
                     <span class="dt">ofv_fun=</span>crit_fcn,
                     <span class="dt">maximize =</span> F)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(output_cost)
<span class="co">#&gt; ===============================================================================</span>
<span class="co">#&gt; FINAL RESULTS</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Optimized Covariates:</span>
<span class="co">#&gt; Group 1: 60.4216</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; OFV = 7.79468e-14</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Efficiency: </span>
<span class="co">#&gt;   (ofv_final / ofv_init) = 6.3299e-14</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Expected parameter </span>
<span class="co">#&gt; relative standard error (%RSE):</span>
<span class="co">#&gt;     Parameter   Values   RSE_0    RSE</span>
<span class="co">#&gt;       bpop[1]     0.15    5.10    5.2</span>
<span class="co">#&gt;       bpop[2]     8.00    3.03    3.1</span>
<span class="co">#&gt;       bpop[3]     1.00   14.26   14.4</span>
<span class="co">#&gt;        D[1,1]     0.07   29.76   31.0</span>
<span class="co">#&gt;        D[2,2]     0.02   36.68   38.3</span>
<span class="co">#&gt;        D[3,3]     0.60   26.75   27.0</span>
<span class="co">#&gt;    SIGMA[1,1]     0.01   32.01   37.5</span>
<span class="co">#&gt;    SIGMA[2,2]     0.25   25.64   24.2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Total running time: 3.858 seconds</span>
<span class="kw"><a href="../reference/get_rse.html">get_rse</a></span>(output_cost<span class="op">$</span>FIM, output_cost<span class="op">$</span>poped.db)
<span class="co">#&gt;    bpop[1]    bpop[2]    bpop[3]     D[1,1]     D[2,2]     D[3,3] </span>
<span class="co">#&gt;   5.199634   3.098482  14.356624  30.990456  38.284929  27.014408 </span>
<span class="co">#&gt; SIGMA[1,1] SIGMA[2,2] </span>
<span class="co">#&gt;  37.537279  24.177495</span>
<span class="kw"><a href="../reference/plot_model_prediction.html">plot_model_prediction</a></span>(output_cost<span class="op">$</span>poped.db)</code></pre></div>
<p><img src="optimization_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Tip: to make the optimization run faster use the option <code>parallel = T</code> in the <code>poped_optim</code> command.<a href="#fnref1">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#introduction">Introduction</a><ul class="nav nav-pills nav-stacked">
<li><a href="#define-a-model">Define a model</a></li>
      </ul>
</li>
      <li><a href="#design-optimization">Design optimization</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://katalog.uu.se/empinfo/?languageId=1&amp;id=N4-631">Andrew C. Hooker</a>, Marco Foracchia, Sebastian Ueckert, Joakim Nyberg.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
